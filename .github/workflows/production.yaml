name: Deployment in Google Play

on:
  push:
    branches: 
      - production/*

jobs:
  verify-semantic-pull-request:
    uses: VeryGoodOpenSource/very_good_workflows/.github/workflows/semantic_pull_request.yml@v1

  verify-flutter:
    uses: ./.github/workflows/flutter_package.yaml
    with:
      flutter_channel: stable
      flutter_version: 3.7.3
      min_coverage: 0

  build-app-bundle:
    name: Build Flutter (Android)
    needs: [verify-flutter, verify-semantic-pull-request]
    runs-on: ubuntu-latest

    steps:
      - name: 📚 Git Checkout
        uses: actions/checkout@v3

      - name: 🐦 Setup Flutter
        uses: subosito/flutter-action@v2

      - name: 📦 Install Dependencies
        run: flutter packages get

      # - name: 🪄 Decode Keystore
      #   id: write_file
      #   uses: timheuer/base64-to-file@v1
      #   with:
      #     fileName: "app_keystore.jks"
      #     fileDir: './outputs/'
      #     encodedString: ${{ secrets.KEYSTORE }}

      # - name: Decode secret
      #   uses: davidSchuppa/base64Secret-toFile-action@v1
      #   with:
      #       secret: ${{ secrets.KEYSTORE }}
      #       filename: app_keystore.jks
      #       destination-path: ./outputs/

      - name: Setup JDK 8
        uses: actions/setup-java@v1
        with:
          java-version: 8

      - name: 💪 Build app bundle
        run: flutter build appbundle --release --build-name=1.0.${{ github.run_number }} --build-number=${{ github.run_number }}

      - name: Sign app bundle
        run: |
          cd android
          echo ${{ secrets.KEYSTORE }} > app-keystore
          echo -e "storePassword=$ANDROID_KEYSTORE_PASSWORD\nkeyAlias=$ANDROID_KEYSTORE_ALIAS\nkeyPassword=$ANDROID_KEYSTORE_PRIVATE_KEY_PASSWORD" > keystore.properties
          ./gradlew bundleRelease --info --stacktrace
        env:
          STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEYSTORE_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PRIVATE_KEY_PASSWORD }}

      # - name: 💪 Build App Bundle
      #   run: flutter build appbundle --release --build-name=1.0.${{ github.run_number }} --build-number=${{ github.run_number }}
      #   env:
      #     ANDROID_KEYSTORE_PATH: ${{ steps.write_file.outputs.filePath }}
      #     ANDROID_KEYSTORE_ALIAS: ${{ secrets.ANDROID_KEYSTORE_ALIAS }}
      #     ANDROID_KEYSTORE_PRIVATE_KEY_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PRIVATE_KEY_PASSWORD }}
      #     ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}

      - name: 🧷 Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: app-release
          path: build/app/outputs/bundle/release/

  publish-play-store:
    name: Publish to Play Store
    needs: [build-app-bundle]
    runs-on: ubuntu-latest

    steps:
      - name: 📚 Git Checkout
        uses: actions/checkout@v3

      - name: 🧷 Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: app-release
          
      - name: 🚀 Deploy to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT }}
          packageName: com.britodev.calculeimc
          releaseFiles: app-release.aab
          track: alpha
          status: completed